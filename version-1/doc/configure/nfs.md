# Vibus, версия 1

## Установка и настройка NFS на CentOS 8

Далее предполагаем, что
- 10.20.20.8 = сервер
- 10.20.20.9 - клиент

### Настройка сервера

Устанавливаем **nfs-server**
```bash
dnf install nfs-utils
```
Запускаем сервер и добавляем  в автозагрузку
```bash
systemctl start nfs-server
systemctl enable nfs-server
systemctl status nfs-server
```
Создаем папку которую будем шарить, если она еще не существует
```bash
mkdir -p /mnt/disk-1/nfs
```
Добавляем созданную папку в файл конфигурации /var/exports
```bash
/mnt/disk-1/nfs				10.20.20.9/24(rw,sync,no_all_squash,no_root_squash)
/mnt/disk-2/nfs				10.20.20.10(rw,sync)
```
тут указываем
* 10.20.20.9/24 - подсеть из которой разрешен доступ
* и/или 10.20.20.10 - ip с которого разрешен доступ
* в скобках указаны параметры доступа

После того как добавили в файл, применяем конфигурацию
```bash
exportfs -arv
```
Чтобы посмотреть какие конфигурации используются выполняем
```bash
exportfs  -s
```
Параметры exportfs:
 *  [клиент:имя-каталога] - добавить или удалить указанную файловую систему для указанного клиента)
 *  -v - выводить больше информации
 *  -r - переэкспортировать все каталоги (синхронизировать /etc/exports и /var/lib/nfs/xtab)
 *  -u - удалить из списка экспортируемых
 *  -a - добавить или удалить все файловые системы
 *  -o - опции через запятую (аналогичен опциям применяемым в /etc/exports; т.о. можно изменять опции уже смонтированных файловых систем)
 *  -i - не использовать /etc/exports при добавлении, только параметры текущей командной строки
 *  -f - сбросить список экспортируемых систем в ядре 2.6;


при необходимости открываем порты файрвола
```bash
firewall-cmd --permanent --add-service=nfs
firewall-cmd --permanent --add-service=rpc-bind
firewall-cmd --permanent --add-service=mountd
firewall-cmd --reload
```
### Настройка клиента

Устанавливаем необходимые пакеты
```bash
dnf install nfs-utils nfs4-acl-tools  
```
Смотрим доступные подключения на сервере
```bash
showmount -e 10.20.20.8
```
Создаем папку куда будем монтировать папки с сервера и монтируем ее
```bash
mkdir -p /mnt/shared-disk-1
mount -t nfs  10.20.20.8:/mnt/shared-disk-1 /mnt/disk-1/nfs
```
Смотрим примонтированные папки
```bash
mount | grep nfs
```
Далее создаем какой-нибудь файл на клиенте
```bash
echo 123 > /mnt/shared-disk-1/test.txt
```
и проверяем его на сервере
```bash
ls -al /mnt/disk-1/nfs/
```
Если все ок, добавляем монтирование папки в автозагрузку
```bash
nano /etc/fstab
```
```text
...
10.20.20.8:/mnt/disk-1/nfs     /mnt/shared-disk-1  nfs     defaults 0 0
```
при необходимости можем добавить различные параметры монтирования, например
```text
archiv:/archiv-small     /archivs/archiv-small  nfs     rw,timeo=4,rsize=16384,wsize=16384   0       0
nfs-server:/archiv-big   /archivs/archiv-big    nfs     rw,timeo=50,hard,fg                  0       0
```
Следующие опции управляют действиями NFS при отсутствии ответа от сервера или в случае возникновения ошибок ввода/вывода:
- fg (bg) (foreground - передний план, background - задний план) - Производить попытки монтирования отказавшей NFS на переднем плане/в фоне.
- hard (soft) - выводит на консоль сообщение "server not responding" при достижении таймаута и продолжает попытки монтирования. При заданной опции soft - при таймауте сообщает вызвавшей операцию программе об ошибке ввода/вывода. (опцию soft советуют не использовать)
- nointr (intr) (no interrupt - не прерывать) - Не разрешает сигналам прерывать файловые операции в жестко смонтированной иерархии каталогов при достижении большого таймаута. intr - разрешает прерывание.
- retrans=n (retransmission value - значение повторной передачи) - После n малых таймаутов NFS генерирует большой таймаут (по-умолчанию 3). Большой таймаут прекращает выполнение операций или выводит на консоль сообщение "server not responding", в зависимости от указания опции hard/soft.
- retry=n (retry value - значение повторно попытки) - Количество минут повторений службы NFS операций монтирования, прежде чем сдаться (по-умолчанию 10000).
- timeo=n (timeout value - значение таймаута) - Количество десятых долей секунды ожидания службой NFS до повторной передачи в случае RPC или малого таймаута (по-умолчанию 7). Это значение увеличивается при каждом таймауте до максимального значения 60 секунд или до наступления большого таймаута. В случае занятой сети, медленного сервера или при прохождении запроса через несколько маршрутизаторов или шлюзов увеличение этого значения может повысить производительность.
- tcp или udp - Для монтирования NFS использовать протокол TCP или UDP соответственно.
- rsize=n (read block size - размер блока чтения) - Количество байтов, читаемых за один раз с NFS-сервера. Стандартно - 4096.
- wsize=n (write block size - размер блока записи) - Количество байтов, записываемых за один раз на NFS-сервер. Стандартно - 4096.

Для увелеичения производительности в быстрых сетях, можно увеличить размер пакета передачи. По-умолчанию, он равен 4кб. Можно увеличить до 16 кб или даже до 32.

Для того, чтобы убедиться что в вашем случае такое увеличение будет работать нормально, можно выполнить обычный пинг указав размер пакета.
```bash
ping -s 32768 10.20.20.8
```
Если время пинга будет в пределах 1-2 мс, тогда можно смело использовать это значение.

## Тестирование скорости

Чтобы узнать скорость сети, запускаем на сервере (10.20.20.8) прослушку порта
```bash
nc -l 1122 > /dev/null
```
Далее на клиенте
```bash
dd if=/dev/zero bs=9100004096 count=1 | nc 10.20.20.8 1122
```
В результате видим, что-то вроде
```bash
0+1 records in
0+1 records out
2147479552 bytes (2.1 GB, 2.0 GiB) copied, 18.4269 s, 117 MB/s
```
тут 117 MB/s скорость сети, 117 MB/s это 0,9 Гб/с - ожидаемо для 1 Гб/с сети

Теперь создаем 1Gb файл на сервере в папке nfs
```bash
fallocate -l 1G test.img
```
переходим на клиент и копируем его вот так
```bash
dd if=/mnt/shared-disk-1 of=/dev/null status=progress
```
в результате видим скорость копирования через NFS и можем сравнить относитлеьно скорости сети
```bash
# dd if=/mnt/shared-disk-1/test.img of=/dev/null status=progress
2097152+0 records in
2097152+0 records out
1073741824 bytes (1.1 GB, 1.0 GiB) copied, 9.21474 s, 117 MB/s
```

## Использованные материалы
- http://www.k-max.name/linux/network-file-system-nfs/
- https://www.tecmint.com/install-nfs-server-on-centos-8/
- https://www.gotoadm.ru/centos-nfs-server-install/
